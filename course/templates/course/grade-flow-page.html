{% extends "course/course-base.html" %}
{% load i18n %}

{% load crispy_forms_tags %}

{% block title %}
   {{ page_data.group_id }}/{{ page_data.page_id }} - {{ flow_identifier}} - {% trans "Grading" %} - {% trans "RELATE" %}
{% endblock %}

{% block root_container %}
  <div class="grading-page-student-work container">
    <div class="row">
      {# {{{ student view #}

      {# {{{ past submissions #}
      {% if prev_grades %}
        <div style="float: right; padding-top:1.5em; margin-right:0 !important;" class="navbar-right">
          <div class="dropdown">
            <button class="btn btn-default dropdown-toggle" type="button" id="past-submission_dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
              {% trans "Past submissions/grades" %}
              <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" aria-labelledby="past-submission_dropdown">
              {% for pgrade in prev_grades %}
              <li>
                {% if forloop.first %}
                  <a class="relate-grading-history-nav" href="?">
                {% else %}
                  <a class="relate-grading-history-nav" href="?grade_id={{ pgrade.id }}">
                {% endif %}

                {% if prev_grade_id == pgrade.id %}<b>{% endif %}
                 {% trans "Submission:" %} {{ pgrade.visit.visit_time }}
                  &middot; {% trans "Grade:" %}
                  {{ pgrade.grade_time }}
                {% if prev_grade_id == pgrade.id %}</b>{% endif %}

                {% if forloop.first %}
                  {% trans "(current)" %}
                {% endif %}
                {% if pgrade.value == None %}
                  [{% trans "no grade" %}]
                {% else %}
                  [{{ pgrade.value}}
                  {# Translators: the unit name in grading #}
                  {% blocktrans trimmed  count counter=pgrade.value %}
                  point
                  {% plural %}
                  points
                  {% endblocktrans %}]
                {% endif %}
              </a></li>
              {% endfor %}
            </ul>
          </div>
        </div>
      {% endif %}

      {# }}} #}
      {{ body|safe }}

      {% if form_html %}
        <div class="well relate-interaction-container">
          {{ form_html|safe }}
        </div>
      {% endif %}

      {% if feedback %}
        <div class="alert
          {% if feedback.correctness >= 1 %}
            alert-success
          {% elif feedback.correctness == 0 %}
            alert-danger
          {% else%}
            alert-info
          {% endif %}
          ">
            <p>{{ feedback.feedback|safe }}</p>
            {% if feedback.bulk_feedback %}
              <p>{{ feedback.bulk_feedback|safe }}</p>
            {% endif %}
        </div>
      {% endif %}

      {# }}} #}

    </div>
  </div>
  <div class="grading-page-grade-entry container">
    <div class="row">
      <h1> {% trans "Grading" %}: <tt>{{ flow_identifier}} - {{ page_data.group_id }}/{{ page_data.page_id }}</tt> </h1>

      {% include "base-page-top.html" %}

      {% if grading_form_html != None or select2_graded_form %}
          <div>
            {% if select2_graded_form %}
              {% crispy select2_graded_form %}
            {% endif %}
            {% if select2_ungraded_form %}
              {% crispy select2_ungraded_form %}
            {% endif %}
          </div>
          <script>
            function navigate_to_grading_page(e){
              {# http://stackoverflow.com/a/33248730/3437454 #}
              {# comment #}
              // the query string should not contain grade_id, or else 404,
              // that's why select2 is not enabled when viewing history grade
              {# endcomment #}
              var qstring = window.location.search.toString();
              if (e.params.data.id){
                $.ajax({
                  url: window.location.origin + "/select2session/{{ course.identifier }}/" + e.params.data.id
                }).done(function (result) {
                  if(result.uri!==window.location.pathname){
                    window.location = result.uri + qstring;}
                });
              }
            }
            {% if select2_graded_form %}
              $("#id_graded_pages").on('select2:select', function(e){
                navigate_to_grading_page(e)
              });
            {% endif %}
            {% if select2_ungraded_form %}
              $("#id_ungraded_pages").on('select2:select', function(e){
                navigate_to_grading_page(e)
              });
            {% endif %}
          </script>
      {% endif %}

      {# {{{ header table #}
      <table class="table table-condensed">
        <thead>
          <th>{% trans "Property" %}</th><th>{% trans "Value" %}</th>
        </thead>
        <tbody>
        {% if grading_opportunity != None %}
          <tr>
            <td>{% trans "Flow session" %}</td>
            <td>
              <tt><a href="{% url "relate-view_single_grade" course.identifier flow_session.participation.id grading_opportunity.id %}"><i class="fa fa-level-up"></i> {{ flow_identifier }}</a></tt>
              <span class="sensitive">
              {% if not pperm.view_participant_masked_profile %}
                  {# Translators: the grade information "for" a participant #}
                  {% blocktrans trimmed with full_name=flow_session.participation.user.get_full_name username=flow_session.participation.user.username %}
                  for
                  {{ full_name }}
                  ({{ username }})
                  {% endblocktrans %}
              {% else %}
                  {# Translators: the grade information "for" a participant #}
                  {% blocktrans trimmed with masked_user_profile=flow_session.participation.user.get_masked_profile %}
                  for
                  {{ masked_user_profile }}
                  {% endblocktrans %}
              {% endif %}
              </span>
            </td>
          </tr>
        {% endif %}
        <tr>
          <td>{% trans "Points awarded" %}</td>
          <td>
            {% if max_points != None %}
              <span class="sensitive">
              {% if points_awarded != None %}
                {{ points_awarded|floatformat:1 }}
              {% else %}
                {% trans "(unknown)" %}
              {% endif %}
              /
              {{ max_points|floatformat:1 }}
              {# Translators: the unit name in grading #}
              {% blocktrans trimmed count counter=max_points %}
                point
              {% plural %}
                points
              {% endblocktrans %}
              </span>
            {% else %}
              {% trans "(n/a)" %}
            {% endif %}
          </td>
        </tr>
        <tr>
          <td>{% trans "Graded" %}</td>
          <td>
            {% if shown_grade != None %}
              {% if shown_grade.grader == None %}
                {% trans "(autograded)" %}
              {% else %}
                {# Translators: the grade is awarded "by" some humman grader. #}
                {% blocktrans trimmed with grader_name=shown_grade.grader.get_full_name %}
                by {{ grader_name }}
                {% endblocktrans %}
              {% endif %}
              {% with time=shown_grade.grade_time %}
                {% trans "at" context "at (what time)" %} {{ time|compact_datetime }}
              {% endwith %}
            {% else %}
              {% trans "(n/a)" %}
            {% endif%}
          </td>
        </tr>
        <tr>
          <td>
            <a
            {% if prev_flow_session_id != None %}
                href="{% url "relate-grade_flow_page" course.identifier prev_flow_session_id prev_flow_session_ordinal %}"
                class="btn btn-default relate-grading-nav"
            {% else %}
                href="#"
                class="btn btn-default disabled"
            {% endif %}
              accesskey="p"
              title="{% trans "Previous page with the same page_id" %} Alt/Cmd(+Shift+)p"
            ><i class="fa fa-chevron-left"></i></a>
            <a
            {% if next_flow_session_id %}
                href="{% url "relate-grade_flow_page" course.identifier next_flow_session_id next_flow_session_ordinal %}"
                   class="btn btn-default relate-grading-nav"
            {% else %}
                href="#"
                class="btn btn-default disabled"
            {% endif %}
              accesskey="n"
              title="{% trans "Next page with the same page_id" %} Alt/Cmd+(Shift+)n"
            ><i class="fa fa-chevron-right"></i></a>
            {% if grading_form_html != None %}
              <a
              {% if next_ungraded_flow_session_id %}
                  href="{% url "relate-grade_flow_page" course.identifier next_ungraded_flow_session_id next_ungraded_flow_session_ordinal %}"
                  class="btn btn-default relate-grading-nav"
              {% else %}
                  href="#"
                  class="btn btn-default disabled"
              {% endif %}
                accesskey="l"
                title="{% trans "Next ungraded page with the same page_id (cyclicly)" %} Alt/Cmd+(Shift+)l"
                ><i class="fa fa fa-forward"></i></a>
            {% endif %}
            {% trans "Session" %}
          </td>
          <td>
            ID: {{ flow_session.id }}
            &middot;{% include "course/flow-session-state.html" %}
            &middot; {% trans "Start:"%} {{ flow_session.start_time|compact_datetime }}

          </td>
        </tr>
        <tr>
          <td>
            <a
            {% if page_data.ordinal > 0 %}
                href="{% url "relate-grade_flow_page" course.identifier flow_session.id page_data.previous_ordinal %}"
                class="btn btn-default relate-grading-nav"
            {% else %}
                href="#"
                class="btn btn-default disabled"
            {% endif %}
              title="{% trans "Previous page in session" %}"
            ><i class="fa fa-chevron-left"></i></a>
            <a
            {% if page_data.next_ordinal < flow_session.page_count %}
                href="{% url "relate-grade_flow_page" course.identifier flow_session.id page_data.next_ordinal %}"
                class="btn btn-default relate-grading-nav"
            {% else %}
                href="#"
                class="btn btn-default disabled"
            {% endif %}
              title="{% trans "Next page in session" %}"
            ><i class="fa fa-chevron-right"></i></a>
            {% trans "Page number" %}
          </td>
          <td>
            {{ ordinal }}
            &middot;
            <a href="{% url "relate-view_flow_page" course.identifier flow_session.id ordinal %}">{% trans "View in flow" %}</a>
          </td>
        </tr>
      </table>
      {# }}} #}

      {% if session_not_for_grading_warning_html %}
        <div class="alert alert-warning">
        <i class="fa fa-warning"></i>
        {{ session_not_for_grading_warning_html|safe }}
        </div>
      {% endif %}

      {# }}} #}

      {# {{{ correct answer #}

      {% if correct_answer  %}
        <div class="panel panel-default">
          <div class="panel-heading" id="correct-answer">{% trans "Correct Answer" %}</div>
          <div class="panel-body">
            <p>{{ correct_answer|safe }}</p>
          </div>
        </div>
      {% endif %}

      {# }}} #}

      {# {{{ grading form #}

      {% if grading_form_html != None %}
        {{ grading_form_html|safe }}
      {% endif %}

      {# }}} #}

    </div>
  </div>

  {# {{{ grade ui #}

  <script>

    // http://stackoverflow.com/a/30558011
    var SURROGATE_PAIR_REGEXP = /[\uD800-\uDBFF][\uDC00-\uDFFF]/g,
        // Match everything outside of normal chars and " (quote character)
        NON_ALPHANUMERIC_REGEXP = /([^\#-~| |!])/g;

    function encode_entities(value)
    {
      return value.
        replace(/&/g, '&amp;').
        replace(SURROGATE_PAIR_REGEXP, function(value) {
          var hi = value.charCodeAt(0);
          var low = value.charCodeAt(1);
          return '&#' + (((hi - 0xD800) * 0x400) + (low - 0xDC00) + 0x10000) + ';';
        }).
        replace(NON_ALPHANUMERIC_REGEXP, function(value) {
          return '&#' + value.charCodeAt(0) + ';';
        }).
        replace(/</g, '&lt;').
        replace(/>/g, '&gt;');
    }

    function truncate_text(s, length)
    {
      if (s.length > length)
        return s.slice(0, length) + "...";
      else
        return s;
    }

    function set_grade_percent(p)
    {
      $("#id_grade_percent").val(p);
    }

    function set_grade_points(p)
    {
      $("#id_grade_points").val(p);
    }

    function set_feedback(p)
    {
      $("#id_feedback_text").val(p);
    }

    function get_feedback_items()
    {
      var items = localStorage["relate_grade_feedback_items"];
      if (items)
        return JSON.parse(items);
      else
        return [];
    }

    function add_feedback(idx)
    {
      var items = get_feedback_items();

      var val = $("#id_feedback_text").val();
      if (val)
        val += "\n";
      val += items[idx];
      $("#id_feedback_text").val(val);
    }

    function add_feedback_item(p)
    {
      var item = prompt("{%trans "Enter new feedback item:" %}");
      if (!item)
        return;

      var items = get_feedback_items();
      items.push(item);
      localStorage["relate_grade_feedback_items"] = JSON.stringify(items);

      update_feedback_items();
    }

    function remove_feedback_item(evt)
    {
      evt.stopPropagation();

      var id = evt.target.parentNode.id.substr("remove_fb_".length);
      var index = parseInt(id);

      var items = get_feedback_items();
      items.splice(index, 1);
      localStorage["relate_grade_feedback_items"] = JSON.stringify(items);

      update_feedback_items();
    }

    function update_feedback_items()
    {
      var buttons = "";

      var items = get_feedback_items();

      buttons += "<p>";
      for (var i = 0; i < items.length; ++i)
      {
        var fb = items[i];
        buttons += ("<button class='btn btn-xs btn-default' type='button' "
            + "onclick='add_feedback(" + i + ")'>"
            + truncate_text(encode_entities(fb), 25)
            + "</button>"
            + " <a class='remove_fb_button' id='remove_fb_"+i+"' href='#'>"
            +   "<i class='fa fa-times-circle'></i>"
            + "</a> "
            );
      }
      buttons += "</p>";

      buttons += "<p>";
      buttons += ("<button class='btn btn-xs btn-default' type='button' "
          + "onclick='add_feedback_item()'><i class='fa fa-plus'></i> {% trans "Add phrase" %}</button>");
      buttons += ("<button class='btn btn-xs btn-default' type='button' "
          + "onclick='set_feedback(\"\")'>{% trans "Clear" %}</button>");
      buttons += "</p>";

      $("#canned_feedback_items").html(buttons);

      $(".remove_fb_button").click(remove_feedback_item);
    }

    function add_grade_ui()
    {
      $(".grading-page-grade-entry #div_id_feedback_text .controls textarea").each(
          function()
          {
            $(this).after("<div id='canned_feedback_items'></div>");
          });

      update_feedback_items();
    }

    $(document).ready(add_grade_ui);

    function getQueryParameterByName(name, url) {
      {# https://stackoverflow.com/a/901144/3437454 #}
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    function format_queryString(qstring) {
      if (qstring.endsWith("&"))
        qstring = qstring.slice(0, -1);
      return qstring.replace("&&", "&").replace("??", "?")
    }

    function update_queryString_parameter(uri, key, value) {
      {# modified from https://stackoverflow.com/a/15023688/3437454 #}
      var re = new RegExp("([?&])" + key + "=.*?(&|#|$)", "i");
      if(uri==="?")
        uri = "";
      if( value === undefined || value === null ) {
        if (uri.match(re)) {
          return format_queryString(uri.replace(re, '$1$2'));
        } else {
          return format_queryString(uri);
        }
      } else {
        if (uri.match(re)) {
          return format_queryString(uri.replace(re, '$1' + key + "=" + value + '$2'));
        } else {
          var hash =  '';
          if( uri.indexOf('#') !== -1 ){
            hash = uri.replace(/.*#/, '#');
            uri = uri.replace(/#.*/, '');
          }
          var separator = uri.indexOf('?') !== -1 ? "&" : "?";
          return format_queryString(uri + separator + key + "=" + value + hash);
        }
      }
    }

    var browser_queryString = window.location.search.toString(),
        updated_queryString = browser_queryString,
        will_skip_graded = true;

    {% if page_data.next_ordinal < flow_session.page_count %}
      var next_page_url = "{% url "relate-grade_flow_page" course.identifier flow_session.id page_data.next_ordinal %}";
    {% else %}
      var next_page_url = null;
    {% endif %}

    {% if next_flow_session_id %}
      var next_session_url = "{% url "relate-grade_flow_page" course.identifier next_flow_session_id next_flow_session_ordinal %}";
    {% else %}
      var next_session_url = null;
    {% endif %}

    {% if next_ungraded_flow_session_id %}
      var next_ungraded_session_url = "{% url "relate-grade_flow_page" course.identifier next_ungraded_flow_session_id next_ungraded_flow_session_ordinal %}";
    {% else %}
      var next_ungraded_session_url = null;
    {% endif %}

    function get_updated_queryString(qstring){
      qstring = update_queryString_parameter(qstring, "grade_id", undefined);
      if(!will_skip_graded){
        qstring= update_queryString_parameter(qstring, "skip_graded", false)
      }
      else{
        qstring = update_queryString_parameter(qstring, "skip_graded", undefined)
      }
      if(qstring === "?"){
        return ""
      }
      return qstring
    }

    function save_and_next_page()
    {
      window.open(next_page_url + updated_queryString, "_blank");
      $("#submit-id-submit").click();
    }

    function save_and_next_session()
    {
      var next_url = will_skip_graded ? next_ungraded_session_url : next_session_url;
      window.open(next_url + updated_queryString, "_blank");
      $("#submit-id-submit").click();
    }

    function update_navigate_queryString(class_name){
      $(class_name).on("click", function(e){
        e.preventDefault();
        if (class_name === ".relate-grading-nav"){
          window.location = update_queryString_parameter(
              $(this).prop("href") + updated_queryString,
              "grade_id", undefined);
        }
        else if (class_name === ".relate-grading-history-nav"){
          var target_grade_id = getQueryParameterByName("grade_id", $(this).prop("href"));
          window.location = update_queryString_parameter(
              window.location.toString(),
              "grade_id", target_grade_id);
        }
      })
    }
    update_navigate_queryString(".relate-grading-nav");
    update_navigate_queryString(".relate-grading-history-nav");

    function queryString_enabled_skip_graded(){
      return getQueryParameterByName("skip_graded") !== "false";
    }

    function get_show_next_session_button(){
      var is_qs_skip_graded = queryString_enabled_skip_graded();
      return (next_session_url && !is_qs_skip_graded)
            || (next_ungraded_session_url && is_qs_skip_graded);
    }

    function add_submit_next()
    {
      var $grading_formgroup_control_last = $(".grading-page-grade-entry .form-group:last .controls:last");
      if (next_page_url)
        $grading_formgroup_control_last.append(
            " <button class='btn btn-primary' id='save_next_page' type='button'>"
            + "{% trans "Submit and next page" %} &raquo;"
            + "</button>");
      if (next_session_url || next_ungraded_session_url){
        var show_next_session_button = get_show_next_session_button();
        $grading_formgroup_control_last.append(
            " <button class='btn btn-primary relate-next-session-btn"
            + (show_next_session_button ? " " : " hidden")
            + "' id='save_next_session' type='button'>"
            + "{% trans "Submit and next session" %} &raquo;"
            + "</button>");
      }

      var noskip = encode_entities('<span class="fa-stack" title="') +
          '{% trans 'Jump to the next ungraded session' %} (Off)' +
          encode_entities('">' +
              '<i class="fa fa-ban fa-stack-2x text-danger"></i>' +
              '<i class="fa fa-forward fa-stack-1x"></i>' +
              '</span>');

      var skip = '<span title="{% trans "Jump to the next ungraded session" %} (On)" '
          + 'class="fa-stack">'
          + '<i class="fa fa-stack-2x"></i>'
          + '<i class="fa fa-forward fa-stack-1x"></i>'
          + '</span>';

      $grading_formgroup_control_last.append(
          ' <label type="button" id="skip_graded_button" class="btn active relate-grade-flow-page-setting-btn"'
          + ' data-noskip-text="' + noskip +  '" '
          + ' data-toggle="button" aria-pressed="true" autocomplete="off">'
          + skip
          + '</label>'
      );

      function toggle_next_session_button_show(){
        if (get_show_next_session_button()){
          $(".relate-next-session-btn").removeClass("hidden");
        }
        else{
          $(".relate-next-session-btn").addClass("hidden");
        }
      }

      function update_browser_queryString(qstring){
        if (history.pushState) {
          var newurl = window.location.origin + window.location.pathname + qstring;
          window.history.pushState({path:newurl},'',newurl);}
      }

      $("#skip_graded_button").on("click", function(e){
        {# there are 2 buttons, need to make them the same #}
        var $this = $(this),
            $other = $(".relate-grade-flow-page-setting-btn").not(this);
        $other.button('toggle');
        if($this.hasClass('active')){
          $this.button('reset');
          $other.button('reset');
        }
        else{
          $this.button('noskip');
          $other.button('noskip');
        }
        will_skip_graded = $this.hasClass('active');
        updated_queryString = get_updated_queryString(updated_queryString);
        update_browser_queryString(updated_queryString);
        toggle_next_session_button_show();
      });

      function initialize_skip_graded_button(){
        if(!queryString_enabled_skip_graded()){
          $(".relate-grade-flow-page-setting-btn").each(
              function(){
                $(this).button("noskip");
              })
        }
        else{
          $(".relate-grade-flow-page-setting-btn").each(
              function(){
                $(this).button("toggle");
              })
        }
        toggle_next_session_button_show();
      }

      $("#save_next_page").click(save_and_next_page);
      $("#save_next_session").click(save_and_next_session);

      {# http://stackoverflow.com/a/9549716/3437454 #}
      $(".relate-grading-form").prepend($(".form-group:last").clone(true, true));
      initialize_skip_graded_button();

    }

      function scroll_to_answer(){
        var percent_box = document.getElementById("id_grade_percent");
        if (percent_box){
          document.getElementById("id_grade_percent").tabIndex = "1";
          document.getElementById("id_grade_points").tabIndex = "2";
        }
        $('html, body > div.grading-page-student-work').animate(
            {scrollTop: $(".relate-interaction-container")
                .position().top}, 1000);

        {% if correct_answer %}
          var item = document.getElementById("correct-answer");
        {% else %}
          var item = document.getElementById("rubric");
          if(item === null){
            item = document.getElementById("grading-form");
          }
        {% endif %}
        $('html, body > div.grading-page-grade-entry').animate(
            {scrollTop: $(item)
                .position().top}, 1000)
      }

    {% if grading_form_html != None %}
      $(document).ready(function() {
        add_submit_next();
        scroll_to_answer();
      });
    {% endif %}
  </script>

  {# }}} #}

{% endblock %}

{# vim: set foldmethod=marker: #}
