{% extends "course/course-base.html" %}
{% load i18n %}
{% load crispy_forms_tags %}

{% load static %}

{% block title %}
  {{ course.number }}
  {% trans "Calendar" %} - {{ relate_site_name }}
{% endblock %}

{% block head_assets_extra %}
  <link rel='stylesheet' href='{% static "fullcalendar/dist/fullcalendar.css" %}'/>
  <script src='{% static "moment/moment.js" %}'></script>
  <script src='{% static "fullcalendar/dist/fullcalendar.js" %}'></script>
  {# load calendar with local language #}
  {% get_current_language as LANGUAGE_CODE %}
  {% if LANGUAGE_CODE != "en" %}
    <script
        src='{% static "fullcalendar/dist/lang/" %}{{ LANGUAGE_CODE |js_lang_fallback:"fullcalendar" }}.js'></script>
  {% endif %}
  {% if pperm.edit_events %}
    <script src='{%  static "blueimp-tmpl/js/tmpl.min.js" %}'></script>
  {% endif %}
{% endblock %}

{% block content %}
  <h1>{{ course.number }} {% trans "Calendar" %}</h1>
  {% if pperm.edit_events %}
    <div>
      <button class="btn btn-primary" id="toggle-calendar-view">
          <span data-edit-mode="true" {% if not is_edit_mode %}hidden{% endif %}>
            {% trans "Switch to Student View" %}</span>
        <span data-edit-mode="false"
              {% if is_edit_mode %}hidden{% endif %}>{% trans "Switch to Edit View" %}</span>
      </button>
      <button id="create-new-event" class="btn btn-danger btn-md" data-toggle="modal"
              data-target="#myModalHorizontal" data-edit-mode="true"

              title="create a new event" {% if not is_edit_mode %}style="display:none;"{% endif %}
      >{% trans "Create a new event" %}</button>
      <button id="new-event" class="btn btn-danger btn-md" data-toggle="modal"
              data-target="#myModalNorm" data-edit-mode="true"
              title="create a new event" {% if not is_edit_mode %}style="display:none;"{% endif %}
      >{% trans "New events" %}</button>
    </div>
  {% endif %}
  <div id="coursecal" data-mode="{% if is_edit_mode %}edit{% else %}view{% endif %}"
       style="margin-top:3em"></div>

  <b class="relate-calendar-notes">{% trans "Note" %}:</b>
  {% trans "Some calendar entries are clickable and link to entries below." %}
  {% if pperm.edit_events %}
    <span data-edit-mode="true">
      ({% trans "Different from the students' calendar, this calender shows <b>all</b> events. " %})</span>
  {% endif %}

  <div id="relate-event-info" style="margin-top:3ex">{{ events_info }}</div>

  {% if pperm.edit_events %}
    <div class="modal fade" id="myModalHorizontal" tabindex="-1" role="dialog"
         aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <button type="button" class="close"
                    data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
              <span class="sr-only">Close</span>
            </button>
            <h4 class="modal-title" id="myModalLabel">
              Modal title
            </h4>
          </div>

          <!-- Modal Body -->
          <div class="modal-body">

            <form class="form-horizontal" role="form">
              <div class="form-group">
                <label class="col-sm-2 control-label"
                       for="inputEmail3">Email</label>
                <div class="col-sm-10">
                  <input type="email" class="form-control"
                         id="inputEmail3" placeholder="Email"/>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label"
                       for="inputPassword3">Password</label>
                <div class="col-sm-10">
                  <input type="password" class="form-control"
                         id="inputPassword3" placeholder="Password"/>
                </div>
              </div>
              <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox"/> Remember me
                    </label>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                  <button type="submit" class="btn btn-default">Sign in</button>
                </div>
              </div>
            </form>

          </div>

          <!-- Modal Footer -->
          <div class="modal-footer">
            <button type="button" class="btn btn-default"
                    data-dismiss="modal">
              Close
            </button>
            <button type="button" class="btn btn-primary">
              Save changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="myModalNorm" tabindex="-1" role="dialog"
         aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <button type="button" class="close"
                    data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
              <span class="sr-only">Close</span>
            </button>
            <h4 class="modal-title" id="myModalLabel">
              {% trans "New event" %}
            </h4>
          </div>
          {% crispy new_event_form %}
        </div>
      </div>
    </div>
  {% endif %}

{% endblock %}

{% block page_bottom_javascript_extra %}
  <script type="text/javascript">
    var coursecal = $('#coursecal'),
      student_view_url = '{% url "relate-toggle_calendar_view" course.identifier 0 %}';

    {% if pperm.edit_events %}
      var edit_view_url = '{% url "relate-toggle_calendar_view" course.identifier 1 %}';
    {% endif %}

    $(document).ready(function () {
      coursecal.fullCalendar({
        header: {
          left: 'prev,next today',
          center: 'title',
          right: 'month,agendaWeek,agendaDay'
        },
        contentHeight: "auto",
        defaultDate: '{{ default_date }}',
        defaultView: $(window).width() < 765 ? 'agendaWeek' : 'month',
        timezone: "local",
        events: {{ events_json|safe }},
        {#        {% if is_edit_mode %}#}
        {#          eventRender: function(event, element) {#}
        {#            element.find('.fc-title').append( '<span class="glyphicon glyphicon-remove-circle" style="float:right;cursor:pointer" id="remove" title="{% trans 'Remove this event'%}" data-confirm="{% trans "Are you sure you want to delete this event?" %}" data-event-id="'+event.id+'"></span>');#}
        {#            element.find('.fc-title').append( '<span class="glyphicon glyphicon-pencil" style="float:right; cursor:pointer" id="edit" title="{% trans 'Edit this event'%}"> </span>');#}
        {#            element.find("#edit").click(function() {#}
        {#              edit_existing_event(event.id);#}
        {#            });#}
        {#            element.find("span[data-confirm]").click(function() {#}
        {#              var event_id = $(this).data('event-id');#}
        {#              if (!$('#deleteConfirmModal').length) {#}
        {#                $('body').append(#}
        {#                    '<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">' +#}
        {#                    '  <div class="modal-dialog" role="document">' +#}
        {#                    '    <div class="modal-content">' +#}
        {#                    '      <div class="modal-header">' +#}
        {#                    '        <button type="button" class="close" data-dismiss="modal" aria-label="Close">' +#}
        {#                    '          <span aria-hidden="true">&times;</span>' +#}
        {#                    '        </button>' +#}
        {#                    '        <h3 class="modal-title" >{% trans "Please confirm" %}</h3>' +#}
        {#                    '      </div>' +#}
        {#                    '      <div class="modal-body">' +#}
        {#                    '      </div>' +#}
        {#                    '      <div class="modal-footer">' +#}
        {#                    '        <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans "Cancel" %}</button>' +#}
        {#                    '        <button type="button" class="btn btn-primary" id="deleteConfirmOK">{% trans "Delete" %}</button>' +#}
        {#                    '      </div>' +#}
        {#                    '    </div>' +#}
        {#                    '  </div>' +#}
        {#                    '</div>');#}
        {#              }#}
        {#              var $delete_confirm_modal = $('#deleteConfirmModal');#}
        {#                  $delete_confirm_modal.find('.modal-body').text($(this).attr('data-confirm'));#}
        {#                  $('#deleteConfirmOK').data('event-id', event_id).click(function() {#}
        {#                delete_existing_event($(this).data('event-id'));#}
        {#              });#}
        {#                  $delete_confirm_modal.modal({show:true});#}
        {#                  return false;#}
        {#              });#}
        {#          }#}
        {#        {% endif %}#}
      });
      {% if pperm.edit_events %}
        {% if is_edit_mode %}
          coursecal.data("mode", "edit");
        {% endif %}
      {% endif %}
    });

    {% if pperm.edit_events %}
      function initialize_ui() {
        if (coursecal.data("mode") === "edit") {
          $("[data-edit-mode='true']").show();
          $("[data-edit-mode='false']").hide();
          coursecal.fullCalendar('option', 'eventMouseover',
            function (event, jsEvent, view) {
              var remove_html = '<span class="relate-event-hover fc-title glyphicon glyphicon-remove-circle" style="float:right;cursor:pointer" id="remove" title="{% trans 'Remove this event'%}" data-confirm="{% trans "Are you sure you want to delete this event?" %}" data-event-id="' + event.id + '"></span>',
                edit_html = '<span class="relate-event-hover fc-title glyphicon glyphicon-pencil" style="float:right; cursor:pointer" id="edit" title="{% trans 'Edit this event'%}"> </span>'
              $('.fc-content', $(this)).append(remove_html).append(edit_html);
            });
          coursecal.fullCalendar('option', 'eventMouseout',
            function (event, jsEvent, view) {
              $(".relate-event-hover", $(this)).remove();
            });
        } else {
          $("[data-edit-mode='true']").hide();
          $("[data-edit-mode='false']").show();
        }
      }

      function refetch_events_data(url, mode) {
        $.ajax({
          url: url,
          dataType: "json"
        })
          .done(function (result) {
            coursecal.fullCalendar('removeEventSources');
            if (result.events) {
              coursecal.fullCalendar('addEventSource', $.parseJSON(result.events));
            }
            $('#relate-event-info').html(result.events_info);
            coursecal.data("mode", mode);
            initialize_ui();
          });
      }

      function toggle_view_mode() {
        var url, mode;
        url = coursecal.data("mode") === "edit" ? student_view_url : edit_view_url;
        mode = coursecal.data("mode") === "edit" ? "view" : "edit";
        refetch_events_data(url, mode);
      }

      {% if edit_existing_event_flag %}
        $('#editModal').modal('show');
      {% endif %}

      $("#toggle-calendar-view").on('click', toggle_view_mode);

      $('#myModalNorm').on('hidden.bs.modal', function () {
        var this_form = $(this).find('form');
        this_form.trigger('reset');
        clear_form_field_errors(this_form);
      });

      $("#new_event").on('submit', function (e) {
        e.preventDefault();
        var self = $(this),
          jqxhr = $.ajax({
            url: self.attr("action"),
            type: "POST",
            data: $("#new_event").serialize(),
            beforeSend: function (xhr, settings) {
              var csrftoken = get_cookie('csrftoken');
              xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success: function (data, textStatus, jqXHR) {
              refetch_events_data(edit_view_url, "edit");
              initialize_ui();
              $('#myModalNorm').modal("hide");
              if (data.message)
                django_message(data.message, "success");
            },
            error: function (data, textStatus, jqXHR) {
              clear_form_field_errors(self);
              var errors = data.responseJSON;
              $.each(errors, function(index, value) {
                    if (index === "__all__") {
                      apply_form_non_field_error(self, value[0]);
                        {#django_message(value[0], "error");#}
                    } else {
                        apply_form_field_error(index, value);
                    }
                });
            }
          })
      });

      function edit_existing_event(event_id) {
        $('#id_to_edit').val(event_id);
        document.existing_event_edit_form.submit();
      }

      function delete_existing_event(event_id) {
        $('#id_to_delete').val(event_id);
        document.existing_event_delete_form.submit();
      }

      function remove_event_id_field() {
        $('#existing_event_to_save').remove()
      }

      function apply_form_field_error(fieldname, error) {
        var input = $("#id_" + fieldname),
          container = $("#div_id_" + fieldname),
          error_msg = $("<span />").addClass("text-danger help-inline ajax-error").text(error[0]);

        container.addClass("has-error error");
        error_msg.insertAfter(input);
      }

      function apply_form_non_field_error(form, error) {
        var form_group_last = $(".form-group:last", $(form)),
          error_msg = $("<div />").addClass("alert alert-danger ajax-error").text(error);
        error_msg.insertAfter(form_group_last);
      }
      function clear_form_field_errors(form) {
        $(".ajax-error", $(form)).remove();
        $(".error", $(form)).removeClass("has-error");
      }

      function django_message(msg, level) {
        var levels = {
            warning: 'alert',
            error: 'error',
            success: 'success',
            info: 'info'
          },
          fontawesome_class = {
            warning: 'warning',
            error: 'ban',
            success: 'check',
            info: 'info-circle'
          },
          html = tmpl("django-message-template", {
            "message": msg, "tags": levels[level],
            "icon_class": fontawesome_class[level],
          });
        $("#message_area").append(html);
      }
    {% endif %}

  </script>

  {% if pperm.edit_events %}
    <script type="text/x-tmpl" id="django-message-template">
      <div class="alert alert-{{ JQ_OPEN }}=o.tags{{ JQ_CLOSE }} fade in" data-alert="{{ JQ_OPEN }}=o.tags{{ JQ_CLOSE }}">
        <a class="close" title="Close" href="#" data-dismiss="alert">&times;</a>
        <i class="fa fa-{{ JQ_OPEN }}=o.icon_class{{ JQ_CLOSE }}"></i>
        {{ JQ_OPEN }}=o.message{{ JQ_CLOSE }}
      </div>
    </script>
  {% endif %}

  {{ block.super }}
{% endblock %}