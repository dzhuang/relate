\BLOCK{- if show_question -}
\BLOCK{- if problem_description_pre -}
\VAR{problem_description_pre}
\BLOCK{- endif -} \#{ problem_description_pre }

\BLOCK{- endif -} \#{ show_question }

\BLOCK{- if show_answer_explanation }


##### 2、求解模型
注：以下各阶段求解表中未列出的状态，由于没有有效的求解结果，已经略去。学生在作答时，若表中列出了这些状态，则该状态下的行**应为空行**，否则结果为错误。


\BLOCK{ set dp_result=dp_result_list[0] }
\BLOCK{ if dp_result_list|length == 2}
\BLOCK{ set compare=True }
\BLOCK{ set dp_result_compare=dp_result_list[1] }
\BLOCK{ set stages_compare = dp_result_compare.verbose_state_x_dict}
\BLOCK{ endif }

\BLOCK{ set stages = dp_result.verbose_state_x_dict}
\BLOCK{for idx in dp_result.verbose_state_x_dict.keys()|reverse}
\BLOCK{ set stage_state_can_optimize = False }
\BLOCK{ set stage = stages[idx] }
\BLOCK{if compare}\BLOCK{ set stage_compare = stages_compare[idx] }\BLOCK{endif}

- <strong> 第\VAR{idx}阶段：</strong>

\BLOCK{ if compare}
\BLOCK{ if stage["state"]!=stage_compare["state"]}
\BLOCK{ set stage_state_can_optimize = True }
本阶段的状态集在计算时可以进一步优化，分别见以下两表：
\BLOCK{endif}
\BLOCK{endif}

<p align="middle"><strong>答案表\VAR{answer_table_iters.next()}: 第\VAR{idx}阶段表\BLOCK{ if stage_state_can_optimize}(优化)\BLOCK{endif}</strong></br>
{% call latex(compiler="pdflatex", image_format="png", tex_preamble=preamble)  %}
\BLOCK{ set state_item_list = stage["state"].items()|list }
\BLOCK{ set n_state = state_item_list[0][1]['state_results']|length }
\newlength\LL \settowidth\LL{100}
\renewcommand\multirowsetup{\centering}
\begin{table}[H]
  \centering
  \begin{mytabular}{c|\BLOCK{for i in range(n_state)}c\BLOCK{endfor}|c|c}
    \hline\hline
     \multirow{2}*{\diagbox{$s_{\VAR{idx}}$}{$x_{\VAR{dp.get_opt_x_subscript(idx)}}$}}& \multicolumn{\VAR{n_state}}{c|}{$\VAR{dp.get_process_function_tex(idx)}$} & \multirow{2}*{$f_{\VAR{idx}}(s_{\VAR{idx}})$} & \multirow{2}{\LL}{$x^*_{\VAR{dp.get_opt_x_subscript(idx)}}$} \\
     \cline{2-\VAR{n_state + 1}}
      &\VAR{stage.decisions|join("&")}&&  \\
    \hline
    \BLOCK{for state in stage.state.items()}
    \VAR{state[0]}& \VAR{state[1]['state_results']|join("&")}&\VAR{state[1]['state_f']}&\VAR{state[1]['state_opt_x']|join(",")}\\
    \BLOCK{endfor}
    \hline\hline
  \end{mytabular}
\end{table}
{% endcall %}
</p>

\BLOCK{ if stage_state_can_optimize}
<p align="middle"><strong>答案表\VAR{answer_table_iters.next()}: 第\VAR{idx}阶段表(未优化)</strong></br>
{% call latex(compiler="pdflatex", image_format="png", tex_preamble=preamble)  %}
\BLOCK{ set n_state = stage_compare["state"].items()[0][1]['state_results']|length }
\newlength\LL \settowidth\LL{100}
\renewcommand\multirowsetup{\centering}
\begin{table}[H]
  \centering
  \begin{mytabular}{c|\BLOCK{for i in range(n_state)}c\BLOCK{endfor}|c|c}
    \hline\hline
     \multirow{2}*{\diagbox{$s_{\VAR{idx}}$}{$x_{\VAR{dp.get_opt_x_subscript(idx)}}$}}& \multicolumn{\VAR{n_state}}{c|}{$\VAR{dp.get_process_function_tex(idx)}$} & \multirow{2}*{$f_{\VAR{idx}}(s_{\VAR{idx}})$} & \multirow{2}{\LL}{$x^*_{\VAR{dp.get_opt_x_subscript(idx)}}$} \\
     \cline{2-\VAR{n_state + 1}}
      &\VAR{stage_compare.decisions|join("&")}&&  \\
    \hline
    \BLOCK{for state in stage_compare.state.items()}
    \VAR{state[0]}& \VAR{state[1]['state_results']|join("&")}&\VAR{state[1]['state_f']}&\VAR{state[1]['state_opt_x']|join(",")}\\
    \BLOCK{endfor}
    \hline\hline
  \end{mytabular}
\end{table}

{% endcall %}
</p>
\BLOCK{ endif } \#{stage_state_can_optimize}
</br>

\BLOCK{ endfor -}

最优指标为$f_1(s_1)=\VAR{dp_result.opt_value}$，\BLOCK{ if dp_result.policy|length > 1}有\VAR{dp_result.policy|length}个最优策略，分别为\BLOCK{else}最优策略为\BLOCK{endif}：
$$
\BLOCK{ for policy in dp_result.policy }
\begin{align*}
\begin{array}{clcl}
\BLOCK{-for idx in dp_result.verbose_state_x_dict.keys()}
\BLOCK{if not loop.first} \Rightarrow \BLOCK{endif} & s_{\VAR{idx}}=\VAR{dp.get_stage_state_transfer_tex(idx)}\VAR{policy[0].state[idx]} & \Rightarrow & x^*_{\VAR{dp.get_opt_x_subscript(idx)}}=\VAR{policy[0].opt_x[idx]} \\
\BLOCK{ endfor}
\end{array}
\end{align*}
$$
\BLOCK{if not loop.last}和\BLOCK{endif}
\BLOCK{ endfor }

\BLOCK{- endif -} \#{ show_answer_explanation }

\BLOCK{ if problem_description_after -}
\VAR{problem_description_after}
\BLOCK{ endif -}



\BLOCK{ if show_blank -}
\BLOCK{ if blank1_desc -}\VAR{blank1_desc}\BLOCK{ endif -}[[blank1]]

\BLOCK{ if blank2_desc -}\VAR{blank2_desc}\BLOCK{ endif -}[[blank2]]

\BLOCK{ if blank3_desc -}\VAR{blank3_desc}\BLOCK{ endif -}[[blank3]]

\BLOCK{ if show_blank4 }\BLOCK{ if blank4_desc -}\VAR{blank4_desc}\BLOCK{ endif -}[[blank4]] \BLOCK{endif}

\BLOCK{ endif -} \#{ after_description }


\BLOCK{ if show_blank_answer }
blank1:
    type: ShortAnswer
    width: 5em
    weight: 0.3
    correct_answer:
    - type: float
      rtol: 1
      atol: 1
      value: \VAR{result.opt_value}

blank2:
    type: ShortAnswer
    width: 5em
    weight: 0.3
    correct_answer:
    - type: float
      rtol: 1
      atol: 1
      value: \VAR{result.policy|length}

blank3:
    type: ShortAnswer
    width: 15em
    weight: 0.3
    prepended_text: "("
    appended_text: ")"
    hint_title: 输入格式示例
    hint: <p>输入最优策略中各个阶段的最优决策序列，例如$(100, 0, 200, 400, 100)$</p>
    correct_answer:
\BLOCK{ for p in result.policy }
\BLOCK{ set opt_x = p[0]["opt_x"].values()}
    - type: float_list_with_wrapper
      rtol: 0.01
      atol: 0.01
      value: "\VAR{opt_x|join(",")}"
\BLOCK{endfor}

blank4:
    type: ShortAnswer
    width: 10em
    prepended_text: "{"
    appended_text: "}"
    weight: 0.1
    hint: 所有可能的最优决策，必须全部写出
    correct_answer:
    - type: float_list_with_wrapper
      as_set: True
      rtol: 0.01
      atol: 0.01
      value: "\VAR{blank4_result|join(",")}"

\BLOCK{ endif -}