(function(b,p,r,e){b.blueimp.fileupload.prototype._specialOptions.push("editModalId","editModalImgId","sortableHandleSelector","sortableOptions","cropperResultMessageBoxSelector","cropperButtonDivSelector","cropperButtonSelector","statusDataName");var k=b.blueimp.fileupload.prototype.options.added;b.widget("blueimp.fileupload",b.blueimp.fileupload,{options:{editModalId:e,editModalImgId:e,cropperResultMessageBoxSelector:e,cropperButtonDivSelector:e,cropperStatusBtnSelector:e,cropperRotateBtnSelector:e,
enableSortable:!0,sortableHandleSelector:e,sortableOptions:e,statusDataName:e,getNumberOfUploadedFiles:function(){return this.filesContainer.children(".template-download").not(".processing").length},getStatus:function(){var a=this,c=[];this.filesContainer.children().not(".processing").each(function(){c.push(b(this).data(a.statusDataName))});return c},added:function(a,c){if(a.isDefaultPrevented())return!1;var d=b(this);d=d.data("blueimp-fileupload")||d.data("fileupload");if(!c.files)return!1;c.replaceChild&&
c.replaceChild.length&&!1!==d._trigger("replace",a,c)&&delete c.replaceChild;b(c.context).find(".edit").prop("disabled",!1);b.isFunction(k)&&k.call(this,a,c);d.toggleFileuploadSortableHandle();d._toggleFileuploadButtonBarButtonDisplay()},replace:function(a,c){if(a.isDefaultPrevented())return!1;var d=b(this);d.data("blueimp-fileupload")||d.data("fileupload");b(c.context).replaceAll(c.replaceChild)},completed:function(a,c){if(a.isDefaultPrevented())return!1;var d=b(this).data("blueimp-fileupload")||
b(this).data("fileupload"),q=d.options;d.toggleFileuploadSortableHandle()._toggleFileuploadButtonBarButtonDisplay()._toggleFileuploadButtonBarDelete();b(this).data.initialStatus===e&&(b(this).data.initialStatus=q.getStatus())},failed:function(a,c){if(a.isDefaultPrevented())return!1;(b(this).data("blueimp-fileupload")||b(this).data("fileupload")).toggleFileuploadSortableHandle()._toggleFileuploadButtonBarButtonDisplay()._toggleFileuploadButtonBarDelete()},destroyed:function(a,c){if(a.isDefaultPrevented())return!1;
(b(this).data("blueimp-fileupload")||b(this).data("fileupload")).toggleFileuploadSortableHandle()._toggleFileuploadButtonBarButtonDisplay()._toggleFileuploadButtonBarDelete()}},_initEventHandlers:function(){this._super();this._on(this.options.filesContainer,{"click .edit":this._editHandler});this._on(this.element,{"change .toggle":this._toggleFileuploadButtonBarDeleteDisable})},_toggleFileuploadButtonBarDeleteDisable:function(a){this.element.find(".fileupload-buttonbar").find(".delete").prop("disabled",
!this.element.find(".toggle").is(":checked"))},toggleFileuploadSortableHandle:function(){b(this);var a=this.options;if(a.enableSortable){var c=a.filesContainer;1<c.children().length?c.find(a.sortableHandleSelector).removeClass("hidden").end():c.find(a.sortableHandleSelector).addClass("hidden").end();return this}},_toggleFileuploadButtonBarButtonDisplay:function(){var a=0===this.options.filesContainer.find(".template-upload").length;this.element.find(".fileupload-buttonbar").find(".start, .cancel").css("display",
a?"none":"").prop("disabled",a).end();return this},_toggleFileuploadButtonBarDelete:function(){var a=this.element,b=0===a.find(".toggle:checked").length,d=!this.options.getNumberOfUploadedFiles();a.find(".fileupload-buttonbar").find(".delete").css("display",d?"none":"").prop("disabled",b).end().find(".toggle").css("display",d?"none":"").end();return this},_editHandler:function(a){a.preventDefault();var c=b(a.currentTarget),d=this.options,e=this.element,h=c.closest(".template-upload,.template-download");
a=h.hasClass("template-download")?"download":"upload";var f=d.editModalId,g=d.editModalImgId;if("upload"===a){var l=h.data("data");if(!l){c.prop("disabled",!0);return}var m,k=l.files[0];b.each(l.originalFiles,function(a,b){if(b.name===k.name)return m=b,!0});if(!m)return;g.prop("src",loadImage.createObjectURL(m));g.processCroppedCanvas=function(a){f.modal("hide");d.cropperButtonSelector.prop("disabled",!0);h.find(".btn").prop("disabled",!0);l.context.addClass("processing");a.toBlob(function(a){a.name=
k.name;e.fileupload("add",{files:[a],replaceChild:b(l.context)})},m.type)}}"download"===a&&(g.attr("src",c.data("src")),g.submitData=function(a){var n=d.cropperResultMessageBoxSelector;d.cropperButtonSelector.prop("disabled",!0);g.cropper("disable");b.ajax({method:"POST",url:c.data("action"),data:{croppedResult:JSON.stringify(a)},beforeSend:function(a,b){a.setRequestHeader("X-CSRFToken",c.data("data"))}}).always(function(){}).done(function(a){d.done.call(e,b.Event("done"),{result:{files:[a.file]},
context:c.closest(".template-download")});n.html("<span class='alert alert-success'>"+a.message+"</span>");f.data("new",!1);setTimeout(function(){f.data("new")||f.modal("hide")},3E3)}).fail(function(a){n.html("<span class='alert alert-danger'>"+a.responseJSON.message+"</span>")});return!1});g.rotateCanvas=function(){var a=b(this),c=a.cropper("getContainerData"),f=a.cropper("getCanvasData"),e=c.height/f.height*f.width;e>=c.width?(f=c.width/f.width*f.height,c={height:f,width:c.width,top:(c.height-f)/
2,left:0}):c={height:c.height,width:e,top:0,left:(c.width-e)/2};a.cropper("setCanvasData",c).cropper("setCropBoxData",c);d.cropperButtonSelector.prop("disabled",!1)};f.modal("show",[g,a])},_initEditModalId:function(){var a=this.options;a.editModalId===e?a.editModalId=this.element.find("#editModal"):a.editModalId instanceof b||(a.editModalId=b(a.editModalId))},_initEditModalImgId:function(){var a=this.options;a.editModalImgId===e?a.editModalImgId=this.element.find("#modalImage"):a.editModalImgId instanceof
b||(a.editModalImgId=b(a.editModalImgId))},_initCropperResultMessageBoxSelector:function(){var a=this.options;a.cropperResultMessageBoxSelector===e?a.cropperResultMessageBoxSelector=this.element.find("#cropper-message"):a.cropperResultMessageBoxSelector instanceof b||(a.cropperResultMessageBoxSelector=b(a.cropperResultMessageBoxSelector))},_initCropperButtonDivSelector:function(){var a=this.options;a.cropperButtonDivSelector===e?a.cropperButtonDivSelector=this.element.find(".cropper-btns"):a.cropperButtonDivSelector instanceof
b||(a.cropperButtonDivSelector=b(a.cropperButtonDivSelector))},_initCropperButtonSelector:function(){var a=this.options;a.cropperButtonSelector=a.cropperButtonDivSelector.find(".btn")},_initCropperStatusBtnSelector:function(){var a=this.options;a.cropperStatusBtnSelector===e?a.cropperStatusBtnSelector=this.element.find(".cropper-status-btns .btn"):a.cropperStatusBtnSelector instanceof b||(a.cropperStatusBtnSelector=b(a.cropperStatusBtnSelector))},_initCropperRotateBtnSelector:function(){var a=this.options;
a.cropperRotateBtnSelector===e?a.cropperRotateBtnSelector=this.element.find(".cropper-rotate-btns .btn"):a.cropperRotateBtnSelector instanceof b||(a.cropperRotateBtnSelector=b(a.cropperRotateBtnSelector))},_initEditModalEventHandler:function(){var a=this,c=a.options,d,e,h;this.options.editModalId.on("show.bs.modal",function(a){d=a.relatedTarget[0];e=a.relatedTarget[1]}).on("shown.bs.modal",function(){b(this).data("new",!0);a._trigger("modalshownevent",event,!0);d.cropper({viewMode:1,checkOrientation:!1,
autoCrop:!0,autoCropArea:1,strict:!0,movable:!1,zoomable:!1,minContainerheight:.8*b(p).height(),ready:function(a){h=d.cropper("getData","true");c.cropperRotateBtnSelector.prop("disabled",!1)},cropstart:function(c){a._trigger("modalinprogessstatus",event,!0)},crop:function(a){},cropend:function(b){b=d.cropper("getData","true");b=JSON.stringify(h)===JSON.stringify(b);c.cropperStatusBtnSelector.prop("disabled",b);a._trigger("modalinprogessstatus",event,!b)}})}).on("hidden.bs.modal",function(){a._trigger("modalinprogessstatus",
event,!1);a._trigger("modalhiddenevent",event,!0);d.cropper("destroy");b(this).attr("data-new",!1);c.cropperButtonSelector.prop("disabled",!0);c.cropperResultMessageBoxSelector.empty().end().active=!1}).on("show.bs.modal",function(b){a._trigger("modalshowevent",event,!0)}).on("hide.bs.modal",function(b){a._trigger("modalhideevent",event,!0)});c.cropperButtonDivSelector.on("click","[data-method]",function(){var f=b.extend({},b(this).data());if("rotate"===f.method){var g=d.cropper("getContainerData");
d.cropper("setCropBoxData",{width:2,height:2,top:g.height/2-1,left:g.width/2-1})}else"commit"===f.method&&("download"===e?(f.method="getData",f.option="true"):"upload"===e&&(f.method="getCroppedCanvas"));a._trigger("modalinprogessstatus",event,!0);g=d.cropper(f.method,f.option,f.secondOption);switch(f.method){case "scaleX":case "scaleY":b(this).data("option",-f.option);break;case "reset":c.cropperStatusBtnSelector.prop("disabled",!0);break;case "getData":g&&d.submitData&&d.submitData(g);break;case "getCroppedCanvas":g&&
d.processCroppedCanvas&&d.processCroppedCanvas(g);break;case "rotate":g&&d.rotateCanvas&&d.rotateCanvas()}f=d.cropper("getData","true");JSON.stringify(h)===JSON.stringify(f)&&(c.cropperStatusBtnSelector.prop("disabled",!0),a._trigger("modalinprogessstatus",event,!1))})},_initEditModal:function(){this._initEditModalId();this._initEditModalImgId();this._initCropperResultMessageBoxSelector();this._initCropperButtonDivSelector();this._initCropperButtonSelector();this._initCropperStatusBtnSelector();this._initCropperRotateBtnSelector();
this._initEditModalEventHandler()},_initStatusDataName:function(){var a=this.options;a.statusDataName===e&&(a.statusDataName="file-pk")},_initSortableHandleSelector:function(){this.options.sortableHandleSelector=this._getSortableHandle()},_getSortableHandle:function(){var a=this.options;if(a.sortableHandleSelector===e)return".sortableHandle";if(a.sortableHandleSelector instanceof b)return(void 0).selector},_initSortable:function(){this._initSortableHandleSelector();var a=this.options,c=a.sortableOptions,
d=this;a={delay:500,scrollSpeed:40,handle:a.sortableHandleSelector,helper:"clone",axis:"y",opacity:.9,cursor:"move",start:function(a,b){d._trigger("sortableStart")},stop:function(a,b){d._trigger("sortableStop")},update:function(a,b){d._trigger("sortableUpdate")}};c?(delete c.handle,c=b.extend(a,c)):c=a;this.options.filesContainer.sortable(c).disableSelection()},_initSpecialOptions:function(){this._super();this._initStatusDataName();this._initSortable();this._initEditModal()}})})(jQuery,window,document);