function get_all_pks(a){var b=[];return $(a).fileupload("option","filesContainer").children().not(".processing").each(function(){b.push($(this).attr("data-file-pk"))}),b}function disable_submit_button(a){$(".relate-save-button").prop("disabled",a)}function hide_fileupload_control_button(a,b){$(a).find(".fileupload-buttonbar").find(".start, .cancel").css("display",b?"none":"").prop("disabled",b)}function hide_fileupload_sortable_handle(a){$(a).fileupload("option","filesContainer").children().length>1?$(a).find(".imageSortableHandle").removeClass("hidden"):$(a).find(".imageSortableHandle").addClass("hidden")}function toggle_fileupload_control_delete(a){var b=$(a).find(".fileupload-buttonbar"),c=b.find(".delete"),d=b.find(".toggle"),e=0===$(a).find(".toggle:checked").length,f=!$(a).fileupload("option","filesContainer").children().not(".processing").length;$(c).css("display",f?"none":"").prop("disabled",e),$(d).css("display",f?"none":"")}function disable_fileupload_control_delete_toggle(a,b){$(b).find(".fileupload-buttonbar").find(".toggle").prop("disabled",a)}function getWidthQueryMatch_md_sm_xs(){return window.matchMedia("(max-width: 1023px)").matches}function activate_change_listening(){function e(b,e){return d?e&&"sortstop"===b.type?void(a=JSON.stringify(e)!==JSON.stringify(c)):(a=!0,void(d=!1)):void(a=!0)}function f(b){a=!1,$(".relate-save-button").each(function(){var a=$(this).clone();$(a).attr("disabled","1"),$(this).after(a),$(this).hide()})}var a=!1,b=$("#fileupload");b.fileupload("option","filesContainer").sortable({delay:500,handle:".imageSortableHandle",scrollSpeed:40,helper:"clone",axis:"y",opacity:.9,cursor:"move",stop:function(a,c){window.location.pathname.indexOf("/grading/")===-1&&e(a,get_all_pks(b))}});var c,d=!0;$(window).on("beforeunload",function(){if(a)return gettext("You have unsaved changes on this page.")}),b.on("fileuploadadd",function(a,b){disable_submit_button(!0),hide_fileupload_control_button($(this),!1)}).on("fileuploadadded",function(a,b){e(),hide_fileupload_sortable_handle($(this))}).on("fileuploadcompleted fileuploaddestroyed",function(){var a=get_all_pks($(this)).length;disable_fileupload_control_delete_toggle(!a,$(this)),toggle_fileupload_control_delete($(this)),c?e():c=get_all_pks(b)}).on("fileuploadfailed fileuploadcompleted fileuploaddestroyed",function(){var a=$(this).find(".template-upload").length;disable_submit_button(a>0),hide_fileupload_control_button($(this),!a),hide_fileupload_sortable_handle($(this))}),$("body").on("change",'#fileupload input[type="checkbox"]',function(a){toggle_fileupload_control_delete(b)}),$(".relate-interaction-container form").on("submit",f)}!function(a,b,c,d){"use strict";a.widget("blueimp.fileupload",a.blueimp.fileupload,{options:{EditModalSelector:"#editModal",EditModalImgSelector:"#image",cropResultMessageBoxSelector:"#crp-result",cropControlButtonDivSelector:".cropper-btns",added:function(b,c){var d=a(this),e=d.data("blueimp-fileupload")||d.data("fileupload"),f=e.options;if(c.replaceChild&&c.replaceChild.length){var g=a(f.EditModalSelector);a(c.context).replaceAll(c.replaceChild),g.modal("hide")}if(c.files){var h,i=c.files[0];a.each(c.originalFiles,function(a,b){if(b.name===i.name)return h=b,!0}),h&&a(c.context).find(".edit").prop("disabled",!1)}}},_initEventHandlers:function(){this._super(),this._on(this.options.filesContainer,{"click .edit":this._editHandler})},_editHandler:function(c){c.preventDefault();var d=a(c.currentTarget),e=this.options,f=this.element,g=d.closest(".template-upload,.template-download"),h=g.hasClass("template-download")?"download":"upload",i=a(e.EditModalSelector),j=a(e.EditModalImgSelector);if("upload"===h){var k=g.data("data");if(!k)return void d.prop("disabled",!0);var l,m=k.files[0];if(a.each(k.originalFiles,function(a,b){if(b.name===m.name)return l=b,!0}),!l)return;j.prop("src",loadImage.createObjectURL(l)),j.processCroppedCanvas=function(b){a(e.cropResultMessageBoxSelector);f.find(e.cropControlButtonDivSelector+" .btn").prop("disabled",!0),b.toBlob(function(b){b.name=m.name,f.fileupload("option",{maxNumberOfFiles:e.maxNumberOfFiles+1}),f.fileupload("add",{files:[b],replaceChild:a(k.context)}),f.fileupload("option",{maxNumberOfFiles:e.maxNumberOfFiles-1})},l.type)}}"download"===h&&(j.attr("src",d.data("src")),j.submitData=function(c){var g=a(e.cropResultMessageBoxSelector);a.ajax({method:"POST",url:d.data("action"),data:JSON.stringify(c),beforeSend:function(a,b){a.setRequestHeader("X-CSRFToken",d.data("data"))}}).always(function(){b.setTimeout(function(){g.removeClass().html("")},3e3),setTimeout(function(){i.modal("hide")},3e3)}).done(function(b){e.done.call(f,a.Event("done"),{result:{files:[b.file]},context:d.closest(".template-download")}),g.addClass("alert alert-success").html(b.message)}).fail(function(a){g.addClass("alert alert-danger").html(a.responseJSON.message)});return!1}),j.rotateCanvas=function(){var a=j.cropper("getContainerData"),b=j.cropper("getCanvasData"),c=b.width*(a.height/b.height);if(c>=a.width)var d=b.height*(a.width/b.width),g={height:d,width:a.width,top:(a.height-d)/2,left:0};else g={height:a.height,width:c,top:0,left:(a.width-c)/2};j.cropper("setCanvasData",g),j.cropper("setCropBoxData",g),f.find(e.cropControlButtonDivSelector+" .btn").prop("disabled",!1)},i.modal("show",[j,h])}})}(jQuery,window,document),$(function(){"use strict";var a,b,c=$("#editModal");c.on("show.bs.modal",function(c){a=c.relatedTarget[0],b=c.relatedTarget[1],$(this).find(".modal-body").css({width:"auto",height:"auto","max-height":"100%"})}).on("shown.bs.modal",function(){$(".relate-save-button").addClass("disabled"),a.cropper({viewMode:1,checkOrientation:!1,autoCrop:!0,autoCropArea:1,strict:!0,movable:!1,zoomable:!1,minContainerheight:.8*$(window).height(),ready:function(a){c.find(".cropper-rotate-btns .btn").prop("disabled",!1)},cropstart:function(a){},crop:function(a){},cropend:function(a){c.find(".cropper-status-btns .btn").prop("disabled",!1)}})}).on("hidden.bs.modal",function(){$(".relate-save-button").removeClass("disabled"),a.cropper("destroy"),$(this).find(".cropper-btns .btn").prop("disabled",!0).end()}).on("show.bs.modal",function(a){getWidthQueryMatch_md_sm_xs()&&window.history.pushState("forward",null,"#edit")}).on("hide.bs.modal",function(a){"#edit"===location.hash&&getWidthQueryMatch_md_sm_xs()&&window.history.back()}),c.find(".cropper-btns").on("click","[data-method]",function(){var d=$.extend({},$(this).data());if("rotate"===d.method){var e=a.cropper("getContainerData");a.cropper("setCropBoxData",{width:2,height:2,top:e.height/2-1,left:e.width/2-1}),e=null}else"commit"===d.method&&("download"===b?d.method="getData":"upload"===b&&(d.method="getCroppedCanvas"));var f=a.cropper(d.method,d.option,d.secondOption);switch(d.method){case"scaleX":case"scaleY":$(this).data("option",-d.option);break;case"reset":c.find(".cropper-status-btns .btn").prop("disabled",!0);break;case"getData":f&&a.submitData&&a.submitData(f);break;case"getCroppedCanvas":f&&a.processCroppedCanvas&&a.processCroppedCanvas(f);break;case"rotate":f&&a.rotateCanvas&&a.rotateCanvas()}})}),$("#blueimp-gallery").on("open",function(a){getWidthQueryMatch_md_sm_xs()&&window.history.pushState("forward",null,"#slides")}).on("close",function(a){"#slides"==location.hash&&getWidthQueryMatch_md_sm_xs()&&window.history.back()}),$(window).on("popstate",function(a){if(null!==a.state&&getWidthQueryMatch_md_sm_xs()){var b=$("#blueimp-gallery").data("gallery");b?b.close():$(".modal").modal("hide")}}),$(document).ready(function(){"use strict";$(".relate-save-button").each(function(){$(this).attr("formaction",window.location.pathname).detach().appendTo("#actual-submit-div")}).on("click",function(){$("#div_id_hidden_answer").html('<div class="controls"/>').find("div").html('<input type="hidden" id="id_hidden_answer" name="hidden_answer" type="text"/>').find("input").prop("value",get_all_pks($("#fileupload")))})});