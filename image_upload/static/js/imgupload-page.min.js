var EditModalSelector="#editModal",EditModalImgSelector="#image",cropResultMessageBoxSelector="#crop-message",cropControlButtonDivSelector=".cropper-btns",cropControlStatusBtnSelector=".cropper-status-btns .btn";cropControlRotateBtnSelector=".cropper-rotate-btns .btn";
(function(a,d,e,f){a.widget("blueimp.fileupload",a.blueimp.fileupload,{options:{EditModalSelector:EditModalSelector,EditModalImgSelector:EditModalImgSelector,cropResultMessageBoxSelector:cropResultMessageBoxSelector,cropControlButtonDivSelector:cropControlButtonDivSelector,added:function(b,c){var h=a(this),h=h.data("blueimp-fileupload")||h.data("fileupload"),d=h.options;c.replaceChild&&c.replaceChild.length&&(a(d.EditModalSelector),a(c.context).replaceAll(c.replaceChild),h._trigger("replaced",b,c));
if(c.files){var e,f=c.files[0];a.each(c.originalFiles,function(a,c){if(c.name===f.name)return e=c,!0});e&&a(c.context).find(".edit").prop("disabled",!1)}}},_initEventHandlers:function(){this._super();this._on(this.options.filesContainer,{"click .edit":this._editHandler});var a=this;this._on(a.element,{"change .toggle":function(c){c=this.element.find(".toggle");a.element.find(".fileupload-buttonbar").find(".delete").prop("disabled",!c.is(":checked"))}})},_editHandler:function(b){b.preventDefault();
var c=a(b.currentTarget),d=this.options,e=this.element,f=c.closest(".template-upload,.template-download");b=f.hasClass("template-download")?"download":"upload";var k=a(d.EditModalSelector),g=a(d.EditModalImgSelector);if("upload"===b){var l=f.data("data");if(!l){c.prop("disabled",!0);return}var m,n=l.files[0];a.each(l.originalFiles,function(a,c){if(c.name===n.name)return m=c,!0});if(!m)return;g.prop("src",loadImage.createObjectURL(m));g.processCroppedCanvas=function(c){k.modal("hide");a(d.cropControlButtonDivSelector).find(".btn").prop("disabled",
!0);f.find(".btn").prop("disabled",!0);c.toBlob(function(c){c.name=n.name;d.maxNumberOfFiles++;e.fileupload("add",{files:[c],replaceChild:a(l.context)});d.maxNumberOfFiles--},m.type)}}"download"===b&&(g.attr("src",c.data("src")),g.submitData=function(b){var f=a(d.cropResultMessageBoxSelector);a(d.cropControlButtonDivSelector).find(".btn").prop("disabled",!0);g.cropper("disable");a.ajax({method:"POST",url:c.data("action"),data:JSON.stringify(b),beforeSend:function(a,b){a.setRequestHeader("X-CSRFToken",
c.data("data"))}}).always(function(){}).done(function(b){d.done.call(e,a.Event("done"),{result:{files:[b.file]},context:c.closest(".template-download")});f.html("<span class='alert alert-success'>"+b.message+"</span>");k.data("new",!1);setTimeout(function(){k.data("new")||k.modal("hide")},3E3)}).fail(function(a){f.html("<span class='alert alert-danger'>"+a.responseJSON.message+"</span>")});return!1});g.rotateCanvas=function(){var c=a(this),b=c.cropper("getContainerData"),e=c.cropper("getCanvasData"),
f=b.height/e.height*e.width;f>=b.width?(e=b.width/e.width*e.height,b={height:e,width:b.width,top:(b.height-e)/2,left:0}):b={height:b.height,width:f,top:0,left:(b.width-f)/2};c.cropper("setCanvasData",b).cropper("setCropBoxData",b);a(d.cropControlButtonDivSelector).find(".btn").prop("disabled",!1)};k.modal("show",[g,b])}})})(jQuery,window,document);
$(function(){var a,d,e=$(EditModalSelector),f;e.on("show.bs.modal",function(b){a=b.relatedTarget[0];d=b.relatedTarget[1]}).on("shown.bs.modal",function(){$(this).data("new",!0);$(".relate-save-button").addClass("disabled");a.cropper({viewMode:1,checkOrientation:!1,autoCrop:!0,autoCropArea:1,strict:!0,movable:!1,zoomable:!1,minContainerheight:.8*$(window).height(),ready:function(b){f=a.cropper("getData","true");e.find(cropControlRotateBtnSelector).prop("disabled",!1)},cropstart:function(a){},crop:function(a){},
cropend:function(b){b=a.cropper("getData","true");b=JSON.stringify(f)===JSON.stringify(b);e.find(cropControlStatusBtnSelector).prop("disabled",b)}})}).on("hidden.bs.modal",function(){$(".relate-save-button").removeClass("disabled");a.cropper("destroy");$(this).attr("data-new",!1).find(cropControlButtonDivSelector).find(".btn").prop("disabled",!0).end().end().find(cropResultMessageBoxSelector).empty().end().active=!1}).on("show.bs.modal",function(a){getWidthQueryMatch_md_sm_xs()&&window.history.pushState("forward",
null,"#edit")}).on("hide.bs.modal",function(a){"#edit"===location.hash&&getWidthQueryMatch_md_sm_xs()&&window.history.back()});e.find(cropControlButtonDivSelector).on("click","[data-method]",function(){var b=$.extend({},$(this).data());if("rotate"===b.method){var c=a.cropper("getContainerData");a.cropper("setCropBoxData",{width:2,height:2,top:c.height/2-1,left:c.width/2-1})}else"commit"===b.method&&("download"===d?(b.method="getData",b.option="true"):"upload"===d&&(b.method="getCroppedCanvas"));c=
a.cropper(b.method,b.option,b.secondOption);switch(b.method){case "scaleX":case "scaleY":$(this).data("option",-b.option);break;case "reset":e.find(cropControlStatusBtnSelector).prop("disabled",!0);break;case "getData":c&&a.submitData&&a.submitData(c);break;case "getCroppedCanvas":c&&a.processCroppedCanvas&&a.processCroppedCanvas(c);break;case "rotate":c&&a.rotateCanvas&&a.rotateCanvas()}b=a.cropper("getData","true");JSON.stringify(f)===JSON.stringify(b)&&e.find(cropControlStatusBtnSelector).prop("disabled",
!0)})});function get_all_pks(a){var d=[];$(a).fileupload("option","filesContainer").children().not(".processing").each(function(){d.push($(this).attr("data-file-pk"))});return d}function disable_submit_button(a){$(".relate-save-button").prop("disabled",a)}function hide_fileupload_control_button(a,d){$(a).find(".fileupload-buttonbar").find(".start, .cancel").css("display",d?"none":"").prop("disabled",d)}
function hide_fileupload_sortable_handle(a){1<$(a).fileupload("option","filesContainer").children().length?$(a).find(".imageSortableHandle").removeClass("td-hidden"):$(a).find(".imageSortableHandle").addClass("td-hidden")}
function toggle_fileupload_control_delete(a){var d=$(a).find(".fileupload-buttonbar"),e=d.find(".delete"),d=d.find(".toggle"),f=0===$(a).find(".toggle:checked").length;a=!$(a).fileupload("option","filesContainer").children().not(".processing").length;$(e).css("display",a?"none":"").prop("disabled",f);$(d).css("display",a?"none":"")}function disable_fileupload_control_delete_toggle(a,d){$(d).find(".fileupload-buttonbar").find(".toggle").prop("disabled",a)}
function getWidthQueryMatch_md_sm_xs(){return window.matchMedia("(max-width: 1023px)").matches}$("#blueimp-gallery").on("open",function(a){getWidthQueryMatch_md_sm_xs()&&window.history.pushState("forward",null,"#slides")}).on("close",function(a){"#slides"==location.hash&&getWidthQueryMatch_md_sm_xs()&&window.history.back()});$(window).on("popstate",function(a){null!==a.state&&getWidthQueryMatch_md_sm_xs()&&((a=$("#blueimp-gallery").data("gallery"))?a.close():$(".modal").modal("hide"))});
function activate_change_listening(){function a(a,e){b?e&&"sortstop"===a.type?d=JSON.stringify(e)!==JSON.stringify(f):(d=!0,b=!1):d=!0}var d=!1,e=$("#fileupload");e.fileupload("option","filesContainer").sortable({delay:500,handle:".imageSortableHandle",scrollSpeed:40,helper:"clone",axis:"y",opacity:.9,cursor:"move",stop:function(c,b){-1===window.location.pathname.indexOf("/grading/")&&a(c,get_all_pks(e))}}).disableSelection();var f,b=!0;$(window).on("beforeunload",function(){if(d)return gettext("You have unsaved changes on this page.")});
e.on("fileuploadadd",function(a,b){disable_submit_button(!0);hide_fileupload_control_button($(this),!1)}).on("fileuploadadded",function(b,d){a();hide_fileupload_sortable_handle($(this))}).on("fileuploadcompleted fileuploaddestroyed",function(){var b=get_all_pks($(this)).length;disable_fileupload_control_delete_toggle(!b,$(this));toggle_fileupload_control_delete($(this));f?a():f=get_all_pks(e)}).on("fileuploadfailed fileuploadcompleted fileuploaddestroyed",function(){var a=$(this).find(".template-upload").length;
disable_submit_button(0<a);hide_fileupload_control_button($(this),!a);hide_fileupload_sortable_handle($(this))}).on("fileuploadreplaced",function(a,b){hide_fileupload_sortable_handle($(this))});$(".relate-interaction-container form").on("submit",function(a){d=!1;$(".relate-save-button").each(function(){var a=$(this).clone();$(a).attr("disabled","1");$(this).after(a);$(this).hide()})})}
$(document).ready(function(){$(".relate-save-button").each(function(){$(this).attr("formaction",window.location.pathname).detach().appendTo("#actual-submit-div")}).on("click",function(){$("#div_id_hidden_answer").html('<div class="controls"/>').find("div").html('<input type="hidden" id="id_hidden_answer" name="hidden_answer" type="text"/>').find("input").prop("value",get_all_pks($("#fileupload")))})});