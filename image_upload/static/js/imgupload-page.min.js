(function(a,c,f,b){a.widget("blueimp.fileupload",a.blueimp.fileupload,{options:{EditModalSelector:"#editModal",EditModalImgSelector:"#image",cropResultMessageBoxSelector:"#crp-result",cropControlButtonDivSelector:".cropper-btns",added:function(b,d){var g=a(this),g=g.data("blueimp-fileupload")||g.data("fileupload"),c=g.options;d.replaceChild&&d.replaceChild.length&&(a(c.EditModalSelector),a(d.context).replaceAll(d.replaceChild),g._trigger("replaced",b,d));if(d.files){var e,f=d.files[0];a.each(d.originalFiles,
function(a,d){if(d.name===f.name)return e=d,!0});e&&a(d.context).find(".edit").prop("disabled",!1)}}},_initEventHandlers:function(){this._super();this._on(this.options.filesContainer,{"click .edit":this._editHandler})},_editHandler:function(b){b.preventDefault();var d=a(b.currentTarget),g=this.options,f=this.element;b=d.closest(".template-upload,.template-download");var e=b.hasClass("template-download")?"download":"upload",m=a(g.EditModalSelector),h=a(g.EditModalImgSelector);if("upload"===e){var k=
b.data("data");if(!k){d.prop("disabled",!0);return}var l,n=k.files[0];a.each(k.originalFiles,function(a,b){if(b.name===n.name)return l=b,!0});if(!l)return;h.prop("src",loadImage.createObjectURL(l));h.processCroppedCanvas=function(b){a(g.cropResultMessageBoxSelector);m.modal("hide");f.find(g.cropControlButtonDivSelector+" .btn").prop("disabled",!0);b.toBlob(function(b){b.name=n.name;f.fileupload("option",{maxNumberOfFiles:g.maxNumberOfFiles+1});f.fileupload("add",{files:[b],replaceChild:a(k.context)});
f.fileupload("option",{maxNumberOfFiles:g.maxNumberOfFiles-1})},l.type)}}"download"===e&&(h.attr("src",d.data("src")),h.submitData=function(b){var e=a(g.cropResultMessageBoxSelector);a.ajax({method:"POST",url:d.data("action"),data:JSON.stringify(b),beforeSend:function(a,b){a.setRequestHeader("X-CSRFToken",d.data("data"))}}).always(function(){c.setTimeout(function(){e.removeClass().html("")},3E3);setTimeout(function(){m.modal("hide")},3E3)}).done(function(b){g.done.call(f,a.Event("done"),{result:{files:[b.file]},
context:d.closest(".template-download")});e.addClass("alert alert-success").html(b.message)}).fail(function(a){e.addClass("alert alert-danger").html(a.responseJSON.message)});return!1});h.rotateCanvas=function(){var b=a(this),d=b.cropper("getContainerData"),c=b.cropper("getCanvasData"),e=d.height/c.height*c.width;e>=d.width?(c=d.width/c.width*c.height,d={height:c,width:d.width,top:(d.height-c)/2,left:0}):d={height:d.height,width:e,top:0,left:(d.width-e)/2};b.cropper("setCanvasData",d);b.cropper("setCropBoxData",
d);f.find(g.cropControlButtonDivSelector+" .btn").prop("disabled",!1)};m.modal("show",[h,e])}})})(jQuery,window,document);
$(function(){var a,c,f=$("#editModal");f.on("show.bs.modal",function(b){a=b.relatedTarget[0];c=b.relatedTarget[1];$(this).find(".modal-body").css({width:"auto",height:"auto","max-height":"100%"})}).on("shown.bs.modal",function(){$(".relate-save-button").addClass("disabled");a.cropper({viewMode:1,checkOrientation:!1,autoCrop:!0,autoCropArea:1,strict:!0,movable:!1,zoomable:!1,minContainerheight:.8*$(window).height(),ready:function(a){f.find(".cropper-rotate-btns .btn").prop("disabled",!1)},cropstart:function(a){},
crop:function(a){},cropend:function(a){f.find(".cropper-status-btns .btn").prop("disabled",!1)}})}).on("hidden.bs.modal",function(){$(".relate-save-button").removeClass("disabled");a.cropper("destroy");$(this).find(".cropper-btns .btn").prop("disabled",!0).end()}).on("show.bs.modal",function(a){getWidthQueryMatch_md_sm_xs()&&window.history.pushState("forward",null,"#edit")}).on("hide.bs.modal",function(a){"#edit"===location.hash&&getWidthQueryMatch_md_sm_xs()&&window.history.back()});f.find(".cropper-btns").on("click",
"[data-method]",function(){var b=$.extend({},$(this).data());if("rotate"===b.method){var e=a.cropper("getContainerData");a.cropper("setCropBoxData",{width:2,height:2,top:e.height/2-1,left:e.width/2-1})}else"commit"===b.method&&("download"===c?b.method="getData":"upload"===c&&(b.method="getCroppedCanvas"));e=a.cropper(b.method,b.option,b.secondOption);switch(b.method){case "scaleX":case "scaleY":$(this).data("option",-b.option);break;case "reset":f.find(".cropper-status-btns .btn").prop("disabled",
!0);break;case "getData":e&&a.submitData&&a.submitData(e);break;case "getCroppedCanvas":e&&a.processCroppedCanvas&&a.processCroppedCanvas(e);break;case "rotate":e&&a.rotateCanvas&&a.rotateCanvas()}})});function get_all_pks(a){var c=[];$(a).fileupload("option","filesContainer").children().not(".processing").each(function(){c.push($(this).attr("data-file-pk"))});return c}function disable_submit_button(a){$(".relate-save-button").prop("disabled",a)}
function hide_fileupload_control_button(a,c){$(a).find(".fileupload-buttonbar").find(".start, .cancel").css("display",c?"none":"").prop("disabled",c)}function hide_fileupload_sortable_handle(a){1<$(a).fileupload("option","filesContainer").children().length?$(a).find(".imageSortableHandle").removeClass("hidden"):$(a).find(".imageSortableHandle").addClass("hidden")}
function toggle_fileupload_control_delete(a){var c=$(a).find(".fileupload-buttonbar"),f=c.find(".delete"),c=c.find(".toggle"),b=0===$(a).find(".toggle:checked").length;a=!$(a).fileupload("option","filesContainer").children().not(".processing").length;$(f).css("display",a?"none":"").prop("disabled",b);$(c).css("display",a?"none":"")}function disable_fileupload_control_delete_toggle(a,c){$(c).find(".fileupload-buttonbar").find(".toggle").prop("disabled",a)}
function getWidthQueryMatch_md_sm_xs(){return window.matchMedia("(max-width: 1023px)").matches}$("#blueimp-gallery").on("open",function(a){getWidthQueryMatch_md_sm_xs()&&window.history.pushState("forward",null,"#slides")}).on("close",function(a){"#slides"==location.hash&&getWidthQueryMatch_md_sm_xs()&&window.history.back()});$(window).on("popstate",function(a){null!==a.state&&getWidthQueryMatch_md_sm_xs()&&((a=$("#blueimp-gallery").data("gallery"))?a.close():$(".modal").modal("hide"))});
function activate_change_listening(){function a(a,g){e?g&&"sortstop"===a.type?c=JSON.stringify(g)!==JSON.stringify(b):(c=!0,e=!1):c=!0}var c=!1,f=$("#fileupload");f.fileupload("option","filesContainer").sortable({delay:500,handle:".imageSortableHandle",scrollSpeed:40,helper:"clone",axis:"y",opacity:.9,cursor:"move",stop:function(b,c){-1===window.location.pathname.indexOf("/grading/")&&a(b,get_all_pks(f))}});var b,e=!0;$(window).on("beforeunload",function(){if(c)return gettext("You have unsaved changes on this page.")});
f.on("fileuploadadd",function(a,b){disable_submit_button(!0);hide_fileupload_control_button($(this),!1)}).on("fileuploadadded",function(b,c){a();hide_fileupload_sortable_handle($(this))}).on("fileuploadcompleted fileuploaddestroyed",function(){var d=get_all_pks($(this)).length;disable_fileupload_control_delete_toggle(!d,$(this));toggle_fileupload_control_delete($(this));b?a():b=get_all_pks(f)}).on("fileuploadfailed fileuploadcompleted fileuploaddestroyed",function(){var a=$(this).find(".template-upload").length;
disable_submit_button(0<a);hide_fileupload_control_button($(this),!a);hide_fileupload_sortable_handle($(this))}).on("fileuploadreplaced",function(a,b){hide_fileupload_sortable_handle($(this))});$("body").on("change",'#fileupload input[type="checkbox"]',function(a){toggle_fileupload_control_delete(f)});$(".relate-interaction-container form").on("submit",function(a){c=!1;$(".relate-save-button").each(function(){var a=$(this).clone();$(a).attr("disabled","1");$(this).after(a);$(this).hide()})})}
$(document).ready(function(){$(".relate-save-button").each(function(){$(this).attr("formaction",window.location.pathname).detach().appendTo("#actual-submit-div")}).on("click",function(){$("#div_id_hidden_answer").html('<div class="controls"/>').find("div").html('<input type="hidden" id="id_hidden_answer" name="hidden_answer" type="text"/>').find("input").prop("value",get_all_pks($("#fileupload")))})});