function disable_submit_button(a){var b=document.getElementById("submit-id-submit");null!==b&&(b.disabled=a)}function disable_fileupload_control_button(a){var b=$(".fileupload-buttonbar"),c=$(b).find(".start")[0],d=$(b).find(".cancel")[0];null!==c&&(c.disabled=a),null!==d&&(d.disabled=a)}function toggle_fileupload_control_delete(){if(!getWidthQueryMatch_sm_xs()){var a=$(".fileupload-buttonbar").find(".delete")[0];null!=a&&(a.disabled=0===$("#fileupload").find("[type='checkbox']:checked").length)}}function disable_fileupload_control_delete_checkbox(a){if(!getWidthQueryMatch_sm_xs()){var b=$(".fileupload-buttonbar").find("input[type='checkbox']")[0];a&&(b.checked=!1),b.disabled=a}}function getWidthQueryMatch_md_sm_xs(){return window.matchMedia("(max-width: 1023px)").matches}function getWidthQueryMatch_sm_xs(){return window.matchMedia("(max-width: 767px)").matches}function formatFileSize(a){return"number"!=typeof a?"":a>=1e9?(a/1e9).toFixed(2)+" GB":a>=1e6?(a/1e6).toFixed(2)+" MB":(a/1e3).toFixed(2)+" KB"}function generateImageMobileDescription(a){var b=a.find(".name").text(),c=a.data("file-pk"),d=a.find(".size").text(),e=a.find(".timestr").text();a.children(".fileUploadCompactInfo").html('<p style="width: 30vw;">'+b+"<span onclick=\"$('#moreinfo"+c+'\').toggle(); return false;">...</span></p><div style="display: none;" id="moreinfo'+c+'"><p style="width: 30vw;">'+e+'</p><p style="width: 30vw;">'+d+"</p></div>")}function activate_change_listening(){function b(b){a=!0}function c(a){var b,d;b=$(a).parents("td").width(),null==b?setTimeout(function(){c(a)},50):(d=b*(a.height/a.width),$(a).css({width:"100%",height:d}))}function d(b){a=!1,$(".relate-save-button").each(function(){var a=$(this).clone();$(a).attr("disabled","1"),$(this).after(a),$(this).hide()})}var a=!1;$(":file").on("change",b),$(window).on("beforeunload",function(){if(a)return"{% trans 'You have unsaved changes on this page.' %}"}),$("#img-presentation-table").children("tbody").on("sortchange",b),$("#fileupload").on("fileuploadloadingexistalways",function(){$(".fileupload-download-processing").remove()}).on("file_edited fileuploaddestroyed",b).on("fileuploadcompleted fileuploaddestroyed",function(){var a=$(".template-download").length;disable_fileupload_control_delete_checkbox(0===a),a>1?$(".imageSortableHandle").removeClass("hidden"):$(".imageSortableHandle").addClass("hidden")}).on("fileuploadadd",function(a,b){disable_submit_button(!0),disable_fileupload_control_button(!1)}).on("fileuploadadded",function(a,b){}).on("fileuploadcompleted",function(a,b){getWidthQueryMatch_sm_xs()&&$(this).find("canvas").each(function(){c(this)})}).on("fileuploaddestroyed",toggle_fileupload_control_delete).on("fileuploadfailed fileuploadcompleted fileuploaddestroyed",function(){var a=$(".template-upload").length;disable_submit_button(a>0),disable_fileupload_control_button(0===a)}).on("fileuploadprocessstart",function(){}).on("fileuploadprocessalways",function(a,b){var d=b.files[b.index].preview;getWidthQueryMatch_sm_xs()&&c(d)}),$("body").on("change",'#fileupload input[type="checkbox"]',function(a){toggle_fileupload_control_delete()}),$(".relate-interaction-container form").on("submit",d)}$(document).ready(function(){"use strict";$(".relate-save-button").each(function(){$(this).attr("formaction",window.location.pathname).detach().appendTo("#real-submit-div")}).on("click",function(){var a=[];$("#img-presentation-table").find("tr").each(function(){a.push($(this).attr("data-file-pk")),$("#div_id_hidden_answer").html('<div class="controls"><input type="hidden" id="id_hidden_answer" name="hidden_answer" type="text" value="'+a+'"></div>')}),$("#id_hidden_answer").prop("value",a)}),new Clipboard(".btn-data-copy");$("#img-presentation-table").find("tbody").sortable({delay:500,handle:".imageSortableHandle",scrollSpeed:40,scrollSensitivity:10,helper:"clone",axis:"y",opacity:.9,cursor:"move",activate:function(){},deactivate:function(){}})}),$("#blueimp-gallery").on("open",function(a){getWidthQueryMatch_md_sm_xs()&&window.history.pushState("forward",null,"#slides")}).on("close",function(a){"#slides"==location.hash&&getWidthQueryMatch_md_sm_xs()&&window.history.back()}),window.addEventListener("DOMContentLoaded",function(){"use strict";var a,b,c,d,f,g,h,i,j,k,l,m,n;$("#editPopup").on("show.bs.modal",function(b){$(this).find(".modal-body").css({width:"auto",height:"auto","max-height":"100%"}),n=$(b.relatedTarget);var c=n.attr("data-pk"),e=n.attr("data-src");a=$("#image"),a.attr("src",e),g=n.parents("tr"),h=$("#previewid"+c),i=$("#thumbnail"+c),j=$("#filename"+c),k=$("#filesize"+c),l=$("#filetime"+c),m=$("#deleteurl"+c),d=n.attr("data-action"),f=$("body").scrollTop(),$("body").css({overflow:"hidden",position:"fixed",top:-f})}).on("shown.bs.modal",function(){function e(a,b){var c=$("#crp-result");a===!0?c.addClass("alert alert-success").html(b):c.addClass("alert alert-danger").html(b),window.setTimeout(function(){c.removeClass().html("")},3e3)}function f(c){var d,e,f,g;b=a.cropper("getContainerData"),a.cropper("setCropBoxData",{width:2,height:2,top:b.height/2-1,left:b.width/2-1}),a.cropper("rotate",c),d=a.cropper("getCanvasData"),e=d.width*(b.height/d.height),e>=b.width?(f=d.height*(b.width/d.width),g={height:f,width:b.width,top:(b.height-f)/2,left:0}):g={height:b.height,width:e,top:0,left:(b.width-e)/2},a.cropper("setCanvasData",g),a.cropper("setCropBoxData",g),$(".btn-crp-submit").removeClass("disabled"),$(".btn-crp-reset").removeClass("disabled")}$(".relate-save-button").addClass("disabled"),a.cropper({checkOrientation:!1,autoCrop:!0,autoCropArea:1,strict:!0,movable:!1,zoomable:!1,minContainerheight:.8*$(window).height(),ready:function(c){a.cropper("setContainerData",b),$(".btn-crp-rtt").removeClass("disabled")},cropstart:function(a){$(".btn-crp-submit").removeClass("disabled"),$(".btn-crp-reset").removeClass("disabled")},crop:function(a){c=a},rotate:function(a){}}),$(".btn-crp-rtt").click(function(){f($(this).data("option"))}),$(".btn-crp-preview").click(function(){var b=$(".cropper-container").hasClass("hidden"),c=a.cropper("getCroppedCanvas");b?($(".cropper-container").removeClass("hidden"),$("#preview").addClass("hidden").html(""),$(this).html("<i class='fa fa-eye'></i> <span>"+gettext("Preview")+"</span>"),$(".btn-crp-rtt").removeClass("hidden"),$(".btn-crp-reset").removeClass("hidden")):($(".cropper-container").addClass("hidden"),$("#preview").removeClass("hidden").html(c),$(this).html("<i class='fa fa-pencil'></i> <span>"+gettext("Edit")+"</span>"),$(".btn-crp-rtt").addClass("hidden"),$(".btn-crp-reset").addClass("hidden"))}),$(".btn-crp-submit").click(function(){$(this).addClass("disabled"),$(".modal-footer > button").addClass("disabled");$.ajax({method:"POST",url:d,data:JSON.stringify(a.cropper("getData")),beforeSend:function(a,b){a.setRequestHeader("X-CSRFToken",n.attr("data-data"))}}).done(function(b){var c=b.file;i.prop("id","thumbnail"+c.pk).parents("span").addClass("processing"),window.location.pathname.indexOf("/grading/")===-1?i.removeClass("hidden").prop("src",c.thumbnailUrl):i.prop("src",c.url).prop("style","width:40vw"),g.attr("data-file-pk",c.pk),h.prop("id","previewid"+c.pk).prop("href",c.url),j.prop("id","filename"+c.pk).prop("href",c.url),l.prop("id","filetime"+c.pk).prop("title",c.timestr_title).html(c.timestr_short),k.prop("id","filesize"+c.pk).html(formatFileSize(c.size)),m.prop("id","deleteurl"+c.pk).attr("data-url",c.deleteUrl),n.attr("data-src",c.url).attr("data-action",c.crop_handler_url),generateImageMobileDescription(g),a.cropper("replace",c.url),e(!0,gettext("Done!")),setTimeout(function(){$("#editPopup").modal("hide")},2e3),$("#fileupload").trigger("file_edited")}).fail(function(a){var b=gettext("Failed!")+" "+a.responseJSON.message;e(!1,b),setTimeout(function(){$("#editPopup").modal("hide")},2e3)});return!1}),$(".btn-crp-reset").click(function(){a.cropper("reset"),$(".btn-crp-submit").addClass("disabled"),$(".btn-crp-reset").addClass("disabled")})}).on("hidden.bs.modal",function(){$(".relate-save-button").removeClass("disabled"),a.cropper("destroy"),$("#preview").addClass("hidden").html("")}).on("show.bs.modal",function(a){getWidthQueryMatch_md_sm_xs()&&window.history.pushState("forward",null,"#edit")}).on("hide.bs.modal",function(a){"#edit"==location.hash&&getWidthQueryMatch_md_sm_xs()&&window.history.back(),$("body").css({overflow:"",position:"",top:""}).scrollTop(f)}),$(window).on("popstate",function(a){if(null!==a.state&&getWidthQueryMatch_md_sm_xs()){var b=$("#blueimp-gallery").data("gallery");b?b.close():$(".modal").modal("hide")}})}),$(document).ready(activate_change_listening);