{% extends "base.html" %}
{% load i18n %}

{% load crispy_forms_tags %}

{% block content %}
  <div id="profile-form-info"> </div>
  <h1>{% trans "User Profile" %}</h1>
  <div class="well">
    {% crispy user_form %}
  </div>
  <div class="well">
    <a href="{% url 'relate-logout' %}" class="btn btn-default col-lg-offset-2">{% trans "Sign out" %}</a>
  </div>


<script type="text/javascript">

    // toggle widget
    var url=window.location.href;
    var idx = url.indexOf("?first_login=1");
    var first_login = false;
    if (idx >= 0){first_login = true;}
    
    if(!first_login){
        disable_widget_no_id();
    }
    else{
        if ($("#id_institutional_id").val().length > 0)
        {$('#id_institutional_id').prop('disabled', true);}
    };

    function disable_widget_no_id(){
            $('#div_id_confirm_institutional_id').hide();
            $('#id_institutional_id').prop('disabled', true);
            $("#id_no_institutional_id").prop('checked', true);
    }

    function enable_widget_no_id(){
            $('#div_id_confirm_institutional_id').show();
            $('#id_institutional_id').prop('disabled', false);            
    }


    $(document).on('click', '#id_no_institutional_id', function(event) {
        if (this.checked) {
            disable_widget_no_id();
            $('#id_institutional_id').val("");
            $('#id_confirm_institutional_id').val("")
        } else {
            enable_widget_no_id();
        }
    });


    // ajax form submit

    var profile_form = '#profile-form';
    
    $(document).on('submit', profile_form, function(event){
        event.preventDefault();
        sumbit_ajax();
    });

    function sumbit_ajax() {
        //console.log("create post is working!") // sanity check
        $.ajax({
            url : "{% url 'relate-profile_form_ajax' %}", // the endpoint
            type : "POST", // http method
            data : $(profile_form).serialize(), // data sent with the post request
            success: function(data) {
                if (!(data['success'])) {
                    $(profile_form).replaceWith(data['form_html']);
                }
                else {
                    $('#div_id_confirm_institutional_id').hide();                    
                    $('#id_institutional_id').prop('disabled', true);
                    if ($("#id_institutional_id").val().length > 0){
                        $('#div_id_no_institutional_id').hide();}
                    else{
                        $("#id_no_institutional_id").prop('checked', true);
                    };
                    if (data['success_messages']) {
                        $("#profile-form-info")
                            .addClass("alert alert-info")
                            .html('<i class="fa fa-info-circle"></i> '+data['success_messages']);
                        window.setTimeout(
                            function() {
                                $("#profile-form-info")
                                    .fadeOut()
                                    .removeClass("alert alert-info")
                                    .html("")
                                    .fadeIn();
                                if (first_login){
                                    window.location.replace('{% url "relate-home" %}');
                                };
                            },
                            5000);
                    };
                };
            },
        });
    }

</script>
{% endblock %}
